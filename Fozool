import logging
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import (
    Updater, 
    CommandHandler, 
    MessageHandler, 
    Filters, 
    CallbackContext, 
    ConversationHandler
)

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù„Ø§Ú¯
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', 
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Ù…Ø±Ø§Ø­Ù„ Ú¯ÙØªÚ¯Ùˆ
START, Q_AGE, Q_WEIGHT, Q_HEIGHT, Q_MARITAL, Q_EMOTIONAL, Q_SMOKING, Q_SEX, 
Q_HAPPINESS, Q_PORN, Q_ALCOHOL, Q_CHEAT, Q_INCOME, Q_HOMOSEXUAL = range(14)

# Ø³Ø§Ø®ØªØ§Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
user_data = {}

def start(update: Update, context: CallbackContext) -> int:
    """Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª Ùˆ Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø§Ø®ØªØµØ§ØµÛŒ"""
    user = update.effective_user
    bot_username = context.bot.username
    
    # Ø§ÛŒØ¬Ø§Ø¯ Ù„ÛŒÙ†Ú© Ø§Ø®ØªØµØ§ØµÛŒ
    invite_link = f"https://t.me/{bot_username}?start={user.id}"
    
    # Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¯Ø¹ÙˆØª Ú©Ù†Ù†Ø¯Ù‡
    if user.id not in user_data:
        user_data[user.id] = {"link": invite_link, "confessions": []}
    
    welcome_text = (
        "Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø§Ø¹ØªØ±Ø§Ùâ€ŒÚ¯ÛŒØ± Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒØ¯! ğŸ˜ˆ\n\n"
        "ğŸ‘‡ Ù„ÛŒÙ†Ú© Ø§Ø®ØªØµØ§ØµÛŒ Ø´Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø¹ØªØ±Ø§ÙØ§Øª:\n"
        f"{invite_link}\n\n"
        "Ø§ÛŒÙ† Ù„ÛŒÙ†Ú© Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ³ØªØ§Ù† Ø®ÙˆØ¯ Ø¨ÙØ±Ø³ØªÛŒØ¯ ØªØ§ Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù¾Ø§Ø³Ø® Ø¯Ù‡Ù†Ø¯ Ùˆ "
        "Ø§Ø¹ØªØ±Ø§ÙØ§ØªØ´Ø§Ù† Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯!"
    )
    
    update.message.reply_text(welcome_text)
    return ConversationHandler.END

def start_with_referral(update: Update, context: CallbackContext) -> int:
    """Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± Ø¯Ø¹ÙˆØª Ø´Ø¯Ù‡"""
    user = update.effective_user
    args = context.args
    
    if not args:
        update.message.reply_text("Ù„ÛŒÙ†Ú© Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª! Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù„ÛŒÙ†Ú© Ø§ØµÙ„ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.")
        return ConversationHandler.END
    
    inviter_id = int(args[0])
    
    # Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø¹ÙˆØª Ú©Ù†Ù†Ø¯Ù‡
    context.user_data['inviter_id'] = inviter_id
    context.user_data['confession'] = {}
    
    # Ø´Ø±ÙˆØ¹ Ù¾Ø±Ø³Ø´ Ø³ÙˆØ§Ù„Ø§Øª
    update.message.reply_text(
        "ğŸ˜ˆ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø§Ø¹ØªØ±Ø§Ùâ€ŒÚ¯ÛŒØ± Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒØ¯!\n"
        "Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø±Ø§ÛŒ ØµØ§Ø­Ø¨ Ù„ÛŒÙ†Ú© Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.\n\n"
        "ğŸ‘‡ Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù¾Ø§Ø³Ø® Ø¯Ù‡ÛŒØ¯:\n\n"
        "1. Ø³Ù† Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 20):"
    )
    return Q_AGE

def question_age(update: Update, context: CallbackContext) -> int:
    """Ø°Ø®ÛŒØ±Ù‡ Ø³Ù† Ùˆ Ù¾Ø±Ø³Ø´ ÙˆØ²Ù†"""
    age = update.message.text
    try:
        age = int(age)
        if age <= 0 or age > 120:
            raise ValueError
    except ValueError:
        update.message.reply_text("âŒ Ø³Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±! Ù„Ø·ÙØ§Ù‹ Ø³Ù† ÙˆØ§Ù‚Ø¹ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 20):")
        return Q_AGE
    
    context.user_data['confession']['age'] = age
    update.message.reply_text("2. ÙˆØ²Ù† Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 75):")
    return Q_WEIGHT

def question_weight(update: Update, context: CallbackContext) -> int:
    """Ø°Ø®ÛŒØ±Ù‡ ÙˆØ²Ù† Ùˆ Ù¾Ø±Ø³Ø´ Ù‚Ø¯"""
    weight = update.message.text
    try:
        weight = float(weight)
        if weight <= 0 or weight > 300:
            raise ValueError
    except ValueError:
        update.message.reply_text("âŒ ÙˆØ²Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±! Ù„Ø·ÙØ§Ù‹ ÙˆØ²Ù† ÙˆØ§Ù‚Ø¹ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 75):")
        return Q_WEIGHT
    
    context.user_data['confession']['weight'] = weight
    update.message.reply_text("3. Ù‚Ø¯ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø­Ø³Ø¨ Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 182):")
    return Q_HEIGHT

def question_height(update: Update, context: CallbackContext) -> int:
    """Ø°Ø®ÛŒØ±Ù‡ Ù‚Ø¯ Ùˆ Ù¾Ø±Ø³Ø´ ÙˆØ¶Ø¹ÛŒØª ØªØ§Ù‡Ù„"""
    height = update.message.text
    try:
        height = int(height)
        if height <= 0 or height > 250:
            raise ValueError
    except ValueError:
        update.message.reply_text("âŒ Ù‚Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø±! Ù„Ø·ÙØ§Ù‹ Ù‚Ø¯ ÙˆØ§Ù‚Ø¹ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 182):")
        return Q_HEIGHT
    
    context.user_data['confession']['height'] = height
    
    keyboard = [
        [InlineKeyboardButton("Ø§Ù„Ù - Ù…Ø¬Ø±Ø¯ Ù‡Ø³ØªÙ…", callback_data='Ø§Ù„Ù')],
        [InlineKeyboardButton("Ø¨ - Ù…ØªØ§Ù‡Ù„ Ù‡Ø³ØªÙ…", callback_data='Ø¨')]
    ]
    update.message.reply_text(
        "4. Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ù…Ø¬Ø±Ø¯ Ù‡Ø³ØªÛŒØ¯ ÛŒØ§ Ù…ØªØ§Ù‡Ù„ØŸ",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return Q_MARITAL

def question_marital(update: Update, context: CallbackContext) -> int:
    """Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª ØªØ§Ù‡Ù„ Ùˆ Ù¾Ø±Ø³Ø´ Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯ÛŒ"""
    query = update.callback_query
    query.answer()
    context.user_data['confession']['marital'] = query.data
    
    keyboard = [
        [InlineKeyboardButton("Ø§Ù„Ù - Ø¨Ù„Ù‡", callback_data='Ø§Ù„Ù')],
        [InlineKeyboardButton("Ø¨ - Ø®ÛŒØ±", callback_data='Ø¨')]
    ]
    query.edit_message_text(
        "5. Ø¢ÛŒØ§ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¯Ø± ØªØ¹Ù‡Ø¯ Ø§Ø­Ø³Ø§Ø³ÛŒ Ø¨Ø§ Ú©Ø³ÛŒ Ù‡Ù…Ø±Ø§Ù‡ Ø¨Ø§ Ø§Ø­Ø³Ø§Ø³ Ø®ÙˆØ´Ø¨Ø®ØªÛŒ Ùˆ Ø±Ø¶Ø§ÛŒØª Ù‡Ø³ØªÛŒØ¯ØŸ",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return Q_EMOTIONAL

# (ØªÙˆØ§Ø¨Ø¹ Ù…Ø´Ø§Ø¨Ù‡ Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ§Ù„Ø§Øª Ø¯ÛŒÚ¯Ø± Ø¨Ø§ Ø§Ù„Ú¯ÙˆÛŒ ÛŒÚ©Ø³Ø§Ù†)

def question_homosexual(update: Update, context: CallbackContext) -> int:
    """Ø°Ø®ÛŒØ±Ù‡ Ø¢Ø®Ø±ÛŒÙ† Ø³ÙˆØ§Ù„ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù†ØªÛŒØ¬Ù‡"""
    query = update.callback_query
    query.answer()
    context.user_data['confession']['homosexual'] = query.data
    
    # Ø§Ø±Ø³Ø§Ù„ Ø§Ø¹ØªØ±Ø§ÙØ§Øª Ø¨Ù‡ Ø¯Ø¹ÙˆØª Ú©Ù†Ù†Ø¯Ù‡
    inviter_id = context.user_data['inviter_id']
    confession = context.user_data['confession']
    user = update.effective_user
    
    confession_text = (
        f"ğŸ”¥ Ø§Ø¹ØªØ±Ø§Ù Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ú©Ø§Ø±Ø¨Ø±:\n"
        f"ğŸ‘¤: {user.full_name} (@{user.username if user.username else 'N/A'})\n\n"
        f"Ø³Ù†: {confession.get('age', 'N/A')}\n"
        f"ÙˆØ²Ù†: {confession.get('weight', 'N/A')}\n"
        f"Ù‚Ø¯: {confession.get('height', 'N/A')}\n"
        f"ÙˆØ¶Ø¹ÛŒØª ØªØ§Ù‡Ù„: {confession.get('marital', 'N/A')}\n"
        # ... (Ø¨Ù‚ÛŒÙ‡ ÙÛŒÙ„Ø¯Ù‡Ø§)
        f"Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø±Ø§Ø¨Ø·Ù‡ Ù‡Ù…Ø¬Ù†Ø³Ú¯Ø±Ø§ÛŒØ§Ù†Ù‡: {confession.get('homosexual', 'N/A')}\n"
    )
    
    # Ø°Ø®ÛŒØ±Ù‡ Ø§Ø¹ØªØ±Ø§Ù Ùˆ Ø§Ø±Ø³Ø§Ù„
    if inviter_id in user_data:
        user_data[inviter_id]['confessions'].append(confession_text)
        context.bot.send_message(chat_id=inviter_id, text=confession_text)
    
    # Ù¾Ø§ÛŒØ§Ù† Ú¯ÙØªÚ¯Ùˆ
    query.edit_message_text(
        "âœ… Ø§Ø¹ØªØ±Ø§ÙØ§Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!\n"
        "Ø­Ø§Ù„Ø§ ØµØ§Ø­Ø¨ Ù„ÛŒÙ†Ú© Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ø±Ø§ Ø¨Ø¨ÛŒÙ†Ø¯ ğŸ˜ˆ"
    )
    return ConversationHandler.END

def cancel(update: Update, context: CallbackContext) -> int:
    """Ù„ØºÙˆ Ú¯ÙØªÚ¯Ùˆ"""
    update.message.reply_text('Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.')
    return ConversationHandler.END

def main() -> None:
    """Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª"""
    TOKEN = "TOKEN_BOTFATHER"  # Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ø¨Ø§ ØªÙˆÚ©Ù† ÙˆØ§Ù‚Ø¹ÛŒ
    updater = Updater(TOKEN)
    dispatcher = updater.dispatcher

    # Ù‡Ù†Ø¯Ù„Ø± Ú¯ÙØªÚ¯Ùˆ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø¹ÙˆØª Ø´Ø¯Ù‡
    conv_handler = ConversationHandler(
        entry_points=[CommandHandler('start', start_with_referral)],
        states={
            Q_AGE: [MessageHandler(Filters.text & ~Filters.command, question_age)],
            Q_WEIGHT: [MessageHandler(Filters.text & ~Filters.command, question_weight)],
            Q_HEIGHT: [MessageHandler(Filters.text & ~Filters.command, question_height)],
            Q_MARITAL: [MessageHandler(Filters.regex('^(Ø§Ù„Ù|Ø¨)$'), question_marital)],
            # ... (Ù…Ø±Ø§Ø­Ù„ Ø¯ÛŒÚ¯Ø±)
            Q_HOMOSEXUAL: [MessageHandler(Filters.regex('^(Ø§Ù„Ù|Ø¨)$'), question_homosexual)],
        },
        fallbacks=[CommandHandler('cancel', cancel)],
    )

    # Ù‡Ù†Ø¯Ù„Ø± Ø¯Ø³ØªÙˆØ± start Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§ØµÙ„ÛŒ
    dispatcher.add_handler(CommandHandler('start', start))
    dispatcher.add_handler(conv_handler)

    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
